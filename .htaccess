# Configuration Apache pour Quelio API
# Ce fichier protège l'accès aux fichiers sensibles et n'autorise que l'accès à index.php

# Désactiver MultiViews et le listing des répertoires
Options -MultiViews -Indexes

<IfModule mod_rewrite.c>
    RewriteEngine On

    # Bloquer l'accès aux fichiers cachés (.git, .gitignore, .htaccess, etc.)
    RewriteRule ^\.(.*)$ - [F,L]

    # Bloquer l'accès aux fichiers de configuration
    RewriteRule ^(config|config\.example)\.php$ - [F,L]
    RewriteRule ^(README\.md|composer\.(json|lock))$ - [F,L]

    # Bloquer tous les fichiers PHP sauf index.php
    RewriteCond %{REQUEST_URI} !^.*/index\.php$
    RewriteCond %{REQUEST_FILENAME} \.php$
    RewriteRule .* - [F,L]

    # Rediriger toutes les requêtes vers index.php (front controller)
    # Ne pas rediriger si le fichier existe (sauf PHP) ou si c'est un répertoire
    RewriteCond %{REQUEST_FILENAME} !-f [OR]
    RewriteCond %{REQUEST_FILENAME} \.php$
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^ index.php [L]
</IfModule>

# Protéger les fichiers sensibles (couche supplémentaire de sécurité)
# Note: data.json est accessible via le router avec authentification admin
<FilesMatch "^(config\.php|config\.example\.php|\.git.*|\.htaccess|composer\.(json|lock))$">
    Require all denied
</FilesMatch>

# Autoriser index.php et interdire les autres fichiers PHP
<FilesMatch "\.php$">
    <If "%{REQUEST_URI} =~ m#/index\.php$#">
        Require all granted
    </If>
    <Else>
        Require all denied
    </Else>
</FilesMatch>

# Retourner 404 pour les accès interdits
ErrorDocument 403 /index.php
